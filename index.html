<!DOCTYPE html>
<html>
<head>
    <title>Pengenalan Tulisan Tangan</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/image-segmentation@1.0.1/dist/image-segmentation.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #2d3748;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h1, h2, h3, h4 {
            color: #1a202c;
            margin-bottom: 1rem;
        }

        h1 {
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 2rem;
            color: #2b6cb0;
        }

        .input-section, .drawing-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        canvas {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: crosshair;
            background: white;
            width: 100%;
            max-width: 400px;
            height: auto;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        button {
            background-color: #4299e1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        button:hover {
            background-color: #3182ce;
            transform: translateY(-1px);
        }

        button:active {
            transform: translateY(0);
        }

        input[type="file"] {
            display: none;
        }

        .file-upload {
            background-color: #48bb78;
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .file-upload:hover {
            background-color: #38a169;
        }

        #videoElement, #capturedImage {
            width: 100%;
            max-width: 400px;
            height: auto;
            border-radius: 8px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress {
            width: 0%;
            height: 100%;
            background-color: #4299e1;
            transition: width 0.3s ease-in-out;
        }

        .result-container {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid #e2e8f0;
        }

        .confidence-high { color: #48bb78; }
        .confidence-medium { color: #ed8936; }
        .confidence-low { color: #e53e3e; }

        .image-options {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .image-options label {
            display: inline-flex;
            align-items: center;
            margin-right: 20px;
            cursor: pointer;
        }

        .image-options input[type="radio"] {
            margin-right: 5px;
        }

        .preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .preview-box {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .preview-image {
            width: 100%;
            height: auto;
            border-radius: 6px;
        }

        .error-message {
            background-color: #fff5f5;
            color: #c53030;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            border: 1px solid #feb2b2;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .button-group {
                flex-direction: column;
            }

            button {
                width: 100%;
            }

            .preview-container {
                grid-template-columns: 1fr;
            }
        }

        #loading {
            text-align: center;
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
            margin: 10px 0;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Pengenalan Tulisan Tangan</h1>
        
        <div class="input-section">
            <h3>Metode Input:</h3>
            <label class="file-upload">
                Pilih Gambar
                <input type="file" id="imageUpload" accept="image/*" onchange="handleImageUpload(event)">
            </label>
            <div class="button-group">
                <button onclick="toggleCamera()">Buka Kamera</button>
                <button onclick="captureFromCamera()">Ambil Foto</button>
                <button onclick="stopCamera()">Tutup Kamera</button>
            </div>
            <video id="videoElement" autoplay playsinline></video>
            <img id="capturedImage" alt="Gambar yang Diambil">
            <div id="loading" style="display: none;">
                <div class="loading-spinner"></div>
                <p>Memproses gambar...</p>
                <div class="progress-bar">
                    <div class="progress" id="progressBar"></div>
                </div>
            </div>
        </div>
        
        <div class="drawing-section">
            <h3>Gambar di Sini:</h3>
            <canvas id="canvas" width="400" height="400"></canvas>
            <div class="button-group">
                <button onclick="recognize()">Kenali Gambar</button>
                <button onclick="recognizeImage()">Kenali Teks</button>
                <button onclick="clearCanvas()">Hapus</button>
            </div>
        </div>

        <div class="image-options">
            <h4>Opsi Pemrosesan Gambar:</h4>
            <label>
                <input type="radio" name="imageMode" value="original" checked> Gambar Asli
            </label>
            <label>
                <input type="radio" name="imageMode" value="grayscale"> Grayscale
            </label>
            <label>
                <input type="radio" name="imageMode" value="median"> Median Filter
            </label>
            <label>
                <input type="radio" name="imageMode" value="adaptive"> Adaptive Threshold
            </label>
            <label>
                <input type="radio" name="imageMode" value="full"> Full Processing
            </label>
        </div>

        <div class="preview-container">
            <div class="preview-box">
                <h4>Gambar Asli</h4>
                <img id="originalPreview" class="preview-image">
            </div>
            <div class="preview-box">
                <h4>Gambar Diproses</h4>
                <img id="processedPreview" class="preview-image">
            </div>
        </div>

        <div id="result"></div>
    </div>

    <script src="handwriting.canvas.js"></script>
    <script>
        var canvas = new handwriting.Canvas(document.getElementById("canvas"));
        let stream = null;
        let worker = null;
        let segmentationModel = null;
        
        // Inisialisasi Tesseract worker
        async function initTesseract() {
            try {
                if (!worker) {
                    worker = await Tesseract.createWorker();
                    await worker.loadLanguage('ind');
                    await worker.initialize('ind');
                    await worker.setParameters({
                        tessedit_char_whitelist: 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789.,!?@#$%^&*()_+-=[]{}|;:"\'<>/ ',
                        tessedit_pageseg_mode: Tesseract.PSM.AUTO,
                        preserve_interword_spaces: '1'
                    });
                }
                return true;
            } catch (error) {
                console.error('Error initializing Tesseract:', error);
                return false;
            }
        }

        // Inisialisasi model AI
        async function initAIModels() {
            try {
                // Load model segmentasi
                segmentationModel = await tf.loadGraphModel('https://tfhub.dev/tensorflow/tfjs-model/deeplab/pascal/1/default/1');
                return true;
            } catch (error) {
                console.error('Error loading AI models:', error);
                return false;
            }
        }

        // Fungsi untuk meningkatkan kualitas gambar menggunakan AI
        async function enhanceImage(imageData) {
            try {
                // Konversi imageData ke tensor
                const tensor = tf.browser.fromPixels(imageData)
                    .resizeBilinear([400, 400])
                    .expandDims();

                // Normalisasi
                const normalized = tensor.div(255.0);

                // Terapkan model segmentasi
                const segmentation = await segmentationModel.predict(normalized);
                
                // Proses hasil segmentasi
                const processed = tf.squeeze(segmentation);
                const enhanced = processed.mul(255.0).cast('int32');
                
                // Konversi kembali ke canvas
                const canvas = document.createElement('canvas');
                canvas.width = 400;
                canvas.height = 400;
                await tf.browser.toPixels(enhanced, canvas);
                
                return canvas;
            } catch (error) {
                console.error('Error enhancing image:', error);
                return null;
            }
        }

        // Fungsi untuk mempersiapkan gambar sebelum pengenalan
        async function prepareImageForOCR() {
            const ctx = canvas.cxt;
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            // Enhance gambar menggunakan AI
            const enhancedCanvas = await enhanceImage(imageData);
            if (enhancedCanvas) {
                ctx.drawImage(enhancedCanvas, 0, 0);
            }

            // Terapkan preprocessing tambahan
            const data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
            
            // Konversi ke grayscale dengan bobot yang lebih baik
            for (let i = 0; i < data.length; i += 4) {
                const avg = (data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114);
                const threshold = 128;
                const value = avg > threshold ? 255 : 0;
                data[i] = data[i + 1] = data[i + 2] = value;
            }
            
            // Terapkan filter untuk mengurangi noise
            const tempData = new Uint8ClampedArray(data);
            for (let y = 1; y < canvas.height - 1; y++) {
                for (let x = 1; x < canvas.width - 1; x++) {
                    const idx = (y * canvas.width + x) * 4;
                    const neighbors = [
                        tempData[idx - canvas.width * 4 - 4],
                        tempData[idx - canvas.width * 4],
                        tempData[idx - canvas.width * 4 + 4],
                        tempData[idx - 4],
                        tempData[idx],
                        tempData[idx + 4],
                        tempData[idx + canvas.width * 4 - 4],
                        tempData[idx + canvas.width * 4],
                        tempData[idx + canvas.width * 4 + 4]
                    ];
                    neighbors.sort((a, b) => a - b);
                    data[idx] = data[idx + 1] = data[idx + 2] = neighbors[4];
                }
            }
            
            ctx.putImageData(new ImageData(data, canvas.width, canvas.height), 0, 0);
        }

        // Fungsi untuk memproses gambar
        function processImage(imageData, mode) {
            try {
                // Cek apakah gambar valid
                if (!imageData || !imageData.width || !imageData.height) {
                    throw new Error('Gambar tidak valid atau belum dimuat');
                }

                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = imageData.width;
                canvas.height = imageData.height;
                ctx.drawImage(imageData, 0, 0);

                // Cek apakah canvas berhasil dibuat
                if (canvas.width === 0 || canvas.height === 0) {
                    throw new Error('Canvas tidak valid');
                }

                const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                if (!imgData || !imgData.data) {
                    throw new Error('Gagal mendapatkan data gambar');
                }

                const data = imgData.data;

                switch(mode) {
                    case 'original':
                        // Kembalikan gambar asli
                        return canvas;

                    case 'grayscale':
                        // Konversi ke grayscale dengan bobot yang lebih baik
                        for (let i = 0; i < data.length; i += 4) {
                            const avg = (data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114);
                            data[i] = data[i + 1] = data[i + 2] = avg;
                        }
                        break;

                    case 'median':
                        // Konversi ke grayscale dulu
                        for (let i = 0; i < data.length; i += 4) {
                            const avg = (data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114);
                            data[i] = data[i + 1] = data[i + 2] = avg;
                        }
                        
                        // Terapkan median filter
                        const tempData = new Uint8ClampedArray(data);
                        for (let y = 1; y < canvas.height - 1; y++) {
                            for (let x = 1; x < canvas.width - 1; x++) {
                                const idx = (y * canvas.width + x) * 4;
                                const neighbors = [
                                    tempData[idx - canvas.width * 4 - 4],
                                    tempData[idx - canvas.width * 4],
                                    tempData[idx - canvas.width * 4 + 4],
                                    tempData[idx - 4],
                                    tempData[idx],
                                    tempData[idx + 4],
                                    tempData[idx + canvas.width * 4 - 4],
                                    tempData[idx + canvas.width * 4],
                                    tempData[idx + canvas.width * 4 + 4]
                                ];
                                neighbors.sort((a, b) => a - b);
                                data[idx] = data[idx + 1] = data[idx + 2] = neighbors[4];
                            }
                        }
                        break;

                    case 'adaptive':
                        // Konversi ke grayscale dulu
                        for (let i = 0; i < data.length; i += 4) {
                            const avg = (data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114);
                            data[i] = data[i + 1] = data[i + 2] = avg;
                        }
                        
                        // Adaptive thresholding
                        const blockSize = 15;
                        const C = 2;
                        for (let y = 0; y < canvas.height; y++) {
                            for (let x = 0; x < canvas.width; x++) {
                                const idx = (y * canvas.width + x) * 4;
                                
                                // Hitung rata-rata lokal
                                let sum = 0;
                                let count = 0;
                                for (let by = Math.max(0, y - blockSize); by <= Math.min(canvas.height - 1, y + blockSize); by++) {
                                    for (let bx = Math.max(0, x - blockSize); bx <= Math.min(canvas.width - 1, x + blockSize); bx++) {
                                        const bidx = (by * canvas.width + bx) * 4;
                                        sum += data[bidx];
                                        count++;
                                    }
                                }
                                const threshold = (sum / count) - C;
                                
                                // Terapkan threshold
                                const value = data[idx] > threshold ? 255 : 0;
                                data[idx] = data[idx + 1] = data[idx + 2] = value;
                            }
                        }
                        break;

                    case 'full':
                        // Konversi ke grayscale
                        for (let i = 0; i < data.length; i += 4) {
                            const avg = (data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114);
                            data[i] = data[i + 1] = data[i + 2] = avg;
                        }
                        
                        // Median filter
                        const tempData2 = new Uint8ClampedArray(data);
                        for (let y = 1; y < canvas.height - 1; y++) {
                            for (let x = 1; x < canvas.width - 1; x++) {
                                const idx = (y * canvas.width + x) * 4;
                                const neighbors = [
                                    tempData2[idx - canvas.width * 4 - 4],
                                    tempData2[idx - canvas.width * 4],
                                    tempData2[idx - canvas.width * 4 + 4],
                                    tempData2[idx - 4],
                                    tempData2[idx],
                                    tempData2[idx + 4],
                                    tempData2[idx + canvas.width * 4 - 4],
                                    tempData2[idx + canvas.width * 4],
                                    tempData2[idx + canvas.width * 4 + 4]
                                ];
                                neighbors.sort((a, b) => a - b);
                                data[idx] = data[idx + 1] = data[idx + 2] = neighbors[4];
                            }
                        }
                        
                        // Adaptive thresholding
                        const blockSize2 = 15;
                        const C2 = 2;
                        for (let y = 0; y < canvas.height; y++) {
                            for (let x = 0; x < canvas.width; x++) {
                                const idx = (y * canvas.width + x) * 4;
                                
                                let sum = 0;
                                let count = 0;
                                for (let by = Math.max(0, y - blockSize2); by <= Math.min(canvas.height - 1, y + blockSize2); by++) {
                                    for (let bx = Math.max(0, x - blockSize2); bx <= Math.min(canvas.width - 1, x + blockSize2); bx++) {
                                        const bidx = (by * canvas.width + bx) * 4;
                                        sum += data[bidx];
                                        count++;
                                    }
                                }
                                const threshold = (sum / count) - C2;
                                
                                const value = data[idx] > threshold ? 255 : 0;
                                data[idx] = data[idx + 1] = data[idx + 2] = value;
                            }
                        }
                        break;
                }

                ctx.putImageData(imgData, 0, 0);
                return canvas;
            } catch (error) {
                console.error('Error dalam processImage:', error);
                throw error;
            }
        }

        // Modifikasi fungsi handleImageUpload
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                alert('Silakan pilih file gambar terlebih dahulu');
                return;
            }

            if (!file.type.match('image.*')) {
                alert('File yang dipilih bukan gambar');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    try {
                        const ctx = canvas.cxt;
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        
                        const ratio = Math.min(
                            canvas.width / img.width,
                            canvas.height / img.height
                        );
                        
                        const newWidth = img.width * ratio;
                        const newHeight = img.height * ratio;
                        const x = (canvas.width - newWidth) / 2;
                        const y = (canvas.height - newHeight) / 2;
                        
                        ctx.fillStyle = 'white';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, x, y, newWidth, newHeight);
                        
                        // Tampilkan preview gambar asli
                        const originalPreview = document.getElementById('originalPreview');
                        originalPreview.src = e.target.result;
                        
                        // Proses dan tampilkan preview gambar yang diproses
                        const mode = document.querySelector('input[name="imageMode"]:checked').value;
                        const processedCanvas = processImage(img, mode);
                        const processedPreview = document.getElementById('processedPreview');
                        processedPreview.src = processedCanvas.toDataURL();
                        
                        // Tampilkan gambar yang diupload
                        const capturedImage = document.getElementById('capturedImage');
                        capturedImage.src = e.target.result;
                        capturedImage.style.display = 'block';
                        
                        document.getElementById('result').innerHTML = '';
                    } catch (error) {
                        console.error('Error saat memproses gambar:', error);
                        alert('Terjadi kesalahan saat memproses gambar');
                    }
                };
                
                img.onerror = function() {
                    alert('Gagal memuat gambar');
                };
                
                img.src = e.target.result;
            };
            
            reader.onerror = function() {
                alert('Gagal membaca file');
            };
            
            reader.readAsDataURL(file);
        }

        // Modifikasi fungsi recognizeImage
        async function recognizeImage() {
            const loading = document.getElementById('loading');
            const progressBar = document.getElementById('progressBar');
            const result = document.getElementById('result');
            
            try {
                // Cek apakah canvas kosong
                const canvasData = canvas.canvas.toDataURL();
                if (canvasData === 'data:,' || canvasData === 'data:image/png;base64,') {
                    throw new Error('Canvas kosong. Silakan gambar atau upload gambar terlebih dahulu.');
                }

                if (!worker) {
                    loading.style.display = 'block';
                    result.innerHTML = "Menginisialisasi engine pengenalan teks...";
                    
                    const initialized = await initTesseract();
                    if (!initialized) {
                        throw new Error('Gagal menginisialisasi engine pengenalan teks');
                    }
                }

                loading.style.display = 'block';
                result.innerHTML = "Memproses gambar...";
                
                // Dapatkan mode pemrosesan yang dipilih
                const mode = document.querySelector('input[name="imageMode"]:checked').value;
                
                // Proses gambar sesuai mode yang dipilih
                const img = new Image();
                img.onload = async () => {
                    try {
                        const processedCanvas = processImage(img, mode);
                        
                        // Tampilkan preview gambar yang diproses
                        const processedPreview = document.getElementById('processedPreview');
                        processedPreview.src = processedCanvas.toDataURL();
                        
                        // Lakukan pengenalan teks pada gambar yang sudah diproses
                        const { data: { text, confidence } } = await worker.recognize(processedCanvas.toDataURL(), {
                            tessedit_char_whitelist: 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789.,!?@#$%^&*()_+-=[]{}|;:"\'<>/ ',
                            tessedit_pageseg_mode: Tesseract.PSM.SINGLE_BLOCK,
                            preserve_interword_spaces: '1',
                            tessedit_ocr_engine_mode: '1',
                            textord_heavy_nr: '1',
                            textord_min_linesize: '2.5',
                            textord_max_linesize: '3.5',
                            textord_parallel_baselines: '1',
                            textord_parallel_lines: '1',
                            textord_parallel_boxes: '1',
                            textord_parallel_skew: '1',
                            textord_parallel_skew_angle: '0.1',
                            textord_parallel_skew_angle_tolerance: '0.1'
                        });
                        
                        if (!text || text.trim() === '') {
                            result.innerHTML = "Tidak dapat mengenali teks dalam gambar. Pastikan gambar memiliki teks yang jelas.";
                        } else {
                            const confidencePercent = Math.round(confidence);
                            // Bersihkan hasil teks
                            const cleanedText = text
                                .replace(/[^\w\s.,!?@#$%^&*()_+\-=\[\]{}|;:"'<>/]/g, '') // Hapus karakter aneh
                                .replace(/\s+/g, ' ') // Normalisasi spasi
                                .replace(/([.,!?])\s*/g, '$1 ') // Tambah spasi setelah tanda baca
                                .replace(/\s+([.,!?])/g, '$1') // Hapus spasi sebelum tanda baca
                                .trim();
                            
                            let confidenceClass = 'confidence-low';
                            if (confidencePercent >= 80) {
                                confidenceClass = 'confidence-high';
                            } else if (confidencePercent >= 60) {
                                confidenceClass = 'confidence-medium';
                            }
                                
                            result.innerHTML = `
                                <div class="result-container">
                                    <strong>Hasil Pengenalan:</strong><br>
                                    ${cleanedText}<br>
                                    <small class="${confidenceClass}">Tingkat kepercayaan: ${confidencePercent}%</small>
                                </div>
                            `;
                        }
                    } catch (error) {
                        console.error('Error dalam pemrosesan gambar:', error);
                        result.innerHTML = `<div class="error-message">Gagal memproses gambar: ${error.message}</div>`;
                    } finally {
                        loading.style.display = 'none';
                        progressBar.style.width = '0%';
                    }
                };

                img.onerror = () => {
                    throw new Error('Gagal memuat gambar');
                };

                img.src = canvas.canvas.toDataURL();
            } catch (error) {
                console.error('Error detail:', error);
                let errorMessage = 'Terjadi kesalahan saat mengenali teks. ';
                
                if (error.message.includes('Canvas kosong')) {
                    errorMessage = error.message;
                } else if (error.message.includes('Worker')) {
                    errorMessage += 'Gagal memuat engine pengenalan teks. ';
                } else if (error.message.includes('language')) {
                    errorMessage += 'Gagal memuat bahasa Indonesia. ';
                } else if (error.message.includes('image')) {
                    errorMessage += 'Gagal memproses gambar. ';
                }
                
                errorMessage += 'Silakan coba lagi dengan gambar yang lebih jelas.';
                result.innerHTML = `<div class="error-message">${errorMessage}</div>`;
                loading.style.display = 'none';
                progressBar.style.width = '0%';
            }
        }

        // Tambahkan event listener untuk perubahan mode pemrosesan
        document.querySelectorAll('input[name="imageMode"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const capturedImage = document.getElementById('capturedImage');
                if (capturedImage.src) {
                    const img = new Image();
                    img.onload = () => {
                        const processedCanvas = processImage(img, this.value);
                        const processedPreview = document.getElementById('processedPreview');
                        processedPreview.src = processedCanvas.toDataURL();
                        
                        // Update canvas dengan gambar yang diproses
                        const ctx = canvas.cxt;
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.fillStyle = 'white';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        
                        // Hitung rasio aspek
                        const ratio = Math.min(
                            canvas.width / processedCanvas.width,
                            canvas.height / processedCanvas.height
                        );
                        
                        const newWidth = processedCanvas.width * ratio;
                        const newHeight = processedCanvas.height * ratio;
                        const x = (canvas.width - newWidth) / 2;
                        const y = (canvas.height - newHeight) / 2;
                        
                        ctx.drawImage(processedCanvas, x, y, newWidth, newHeight);
                    };
                    img.src = capturedImage.src;
                }
            });
        });

        // Fungsi untuk mengaktifkan/menonaktifkan kamera
        async function toggleCamera() {
            const videoElement = document.getElementById('videoElement');
            if (videoElement.style.display === 'none') {
                try {
                    const constraints = {
                        video: {
                            facingMode: 'environment',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    };
                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                    videoElement.srcObject = stream;
                    videoElement.style.display = 'block';
                    document.getElementById('capturedImage').style.display = 'none';
                } catch (err) {
                    console.error("Error accessing camera:", err);
                    alert("Tidak dapat mengakses kamera. Pastikan Anda memberikan izin akses kamera dan menggunakan browser yang mendukung (Chrome, Firefox, atau Edge).");
                }
            } else {
                stopCamera();
            }
        }

        // Fungsi untuk menangkap gambar dari kamera
        function captureFromCamera() {
            const videoElement = document.getElementById('videoElement');
            const capturedImage = document.getElementById('capturedImage');
            const ctx = canvas.cxt;

            // Buat canvas sementara untuk menangkap frame
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = videoElement.videoWidth;
            tempCanvas.height = videoElement.videoHeight;
            const tempCtx = tempCanvas.getContext('2d');
            
            // Gambar frame video ke canvas sementara
            tempCtx.drawImage(videoElement, 0, 0);
            
            // Tampilkan gambar yang ditangkap
            capturedImage.src = tempCanvas.toDataURL();
            capturedImage.style.display = 'block';
            
            // Gambar ke canvas utama
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(tempCanvas, 0, 0, canvas.width, canvas.height);
        }

        // Fungsi untuk menghentikan kamera
        function stopCamera() {
            const videoElement = document.getElementById('videoElement');
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                videoElement.srcObject = null;
                videoElement.style.display = 'none';
            }
        }

        // Set callback untuk menampilkan hasil
        canvas.setCallBack(function(data, err) {
            if(err) {
                document.getElementById("result").innerHTML = "Error: " + err;
            } else {
                document.getElementById("result").innerHTML = "Hasil: " + data.join(", ");
            }
        });

        // Set opsi untuk bahasa Indonesia
        canvas.setOptions({
            language: "id",
            numOfReturn: 5
        });

        function recognize() {
            canvas.recognize();
        }

        function clearCanvas() {
            canvas.erase();
            document.getElementById("result").innerHTML = "";
        }

        // Fungsi untuk membersihkan worker saat halaman ditutup
        window.addEventListener('beforeunload', async () => {
            if (worker) {
                await worker.terminate();
                worker = null;
            }
        });
    </script>
</body>
</html> 